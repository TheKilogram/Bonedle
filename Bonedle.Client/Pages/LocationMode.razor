@page "/location"
@using Bonedle.Client.Models
@using Bonedle.Client.Services
@using Bonedle.Client.Components
@using Microsoft.AspNetCore.WebUtilities
@inject IGameService GameService
@inject IBoneDataService BoneDataService
@inject IDailyPuzzleService DailyPuzzleService
@inject NavigationManager Navigation

<div class="game-page location-mode @(IsLevelTwo ? "level-two" : "")">
    <header class="game-header">
        <a href="/" class="back-btn">← Back</a>
        <div class="header-center">
            <h1>BONEDLE</h1>
            <span class="mode-badge">Location Mode</span>
            @if (IsLevelTwo)
            {
                <span class="level-badge">Level 2</span>
            }
        </div>
        <span class="puzzle-number">#@PuzzleNumber</span>
    </header>

    <div class="game-layout">
        <div class="skeleton-area">
            <SkeletonView Difficulty="@Difficulty"
                          BoneColors="@BoneColors"
                          TargetBoneId="@(GameState?.TargetBoneId ?? "")"
                          ShowTarget="@(GameState?.Completed ?? false)" />
        </div>

        <div class="controls-area">
            <div class="input-section">
                <div class="guess-info">
                    <span class="guess-counter">@(GameState?.Guesses.Count ?? 0) / @GameService.MaxGuesses</span>
                </div>

                <BoneInput Difficulty="@Difficulty"
                           OnGuess="@HandleGuess"
                           Disabled="@(GameState?.Completed ?? false)"
                           ExcludedBones="@GuessedBoneNames" />
            </div>

            <div class="guesses-section">
                <GuessHistory Guesses="@GuessResults" MaxGuesses="@GameService.MaxGuesses" />
            </div>
        </div>
    </div>

    @if (ShowLevelUp && !IsLevelTwo)
    {
        <div class="level-up-overlay">
            <div class="level-up-modal">
                <h2>Level 1 Complete!</h2>
                <p>You found the <strong>@TargetBoneName</strong>!</p>
                <p>Ready for Level 2? The full skeleton has 200+ bones!</p>
                <button class="level-up-btn" @onclick="StartLevelTwo">
                    Continue to Level 2 →
                </button>
                <button class="skip-btn" @onclick="@(() => ShowLevelUp = false)">
                    View Results
                </button>
            </div>
        </div>
    }

    <ResultModal IsVisible="@ShowResult"
                 Won="@(GameState?.Won ?? false)"
                 GuessCount="@(GameState?.Guesses.Count ?? 0)"
                 TargetBoneId="@(GameState?.TargetBoneId ?? "")"
                 Stats="@Stats"
                 ShowLevelUp="@false"
                 OnClose="@(() => ShowResult = false)"
                 OnLevelUp="@(() => {})"
                 PuzzleNumber="@PuzzleNumber"
                 ModeName="@(IsLevelTwo ? "Location (Level 2)" : "Location")"
                 Guesses="@GuessResults" />
</div>

@code {
    private GameState? GameState { get; set; }
    private DifficultyLevel Difficulty { get; set; } = DifficultyLevel.Major;
    private string? DateOverride { get; set; }
    private Dictionary<string, string> BoneColors { get; set; } = new();
    private List<GuessResult> GuessResults { get; set; } = new();
    private List<string> GuessedBoneNames { get; set; } = new();
    private PlayerStats Stats { get; set; } = new();
    private bool ShowResult { get; set; }
    private bool ShowLevelUp { get; set; }
    private bool IsLevelTwo { get; set; }
    private int PuzzleNumber { get; set; }
    private string TargetBoneName { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        ParseQueryParameters();
        await LoadGame();
    }

    private void ParseQueryParameters()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("level", out var levelValue))
        {
            IsLevelTwo = levelValue.ToString() == "2";
            Difficulty = IsLevelTwo ? DifficultyLevel.Full : DifficultyLevel.Major;
        }

        if (queryParams.TryGetValue("date", out var dateValue))
        {
            DateOverride = dateValue.ToString();
        }
    }

    private async Task LoadGame()
    {
        GameState = await GameService.GetOrCreateGameAsync(GameMode.Location, Difficulty, DateOverride);
        Stats = await GameService.GetStatsAsync(GameMode.Location, Difficulty);

        var date = DateOverride != null ? DateTime.Parse(DateOverride) : DateTime.UtcNow;
        PuzzleNumber = DailyPuzzleService.GetPuzzleNumber(date);

        var targetBone = BoneDataService.GetBoneById(GameState.TargetBoneId);
        TargetBoneName = targetBone?.DisplayName ?? "";

        // Rebuild state from existing guesses
        BoneColors.Clear();
        GuessResults.Clear();
        GuessedBoneNames.Clear();

        foreach (var boneId in GameState.Guesses)
        {
            var bone = BoneDataService.GetBoneById(boneId);
            if (bone != null)
            {
                var isCorrect = boneId == GameState.TargetBoneId;
                var distance = isCorrect ? 0 : BoneDataService.CalculateDistance(boneId, GameState.TargetBoneId);
                var heatColor = BoneDataService.GetHeatColor(distance);

                BoneColors[boneId] = heatColor;
                GuessResults.Add(new GuessResult(boneId, bone.DisplayName, isCorrect, distance, heatColor));
                GuessedBoneNames.Add(bone.DisplayName);
            }
        }

        if (GameState.Completed)
        {
            ShowResult = true;
        }
    }

    private async Task HandleGuess(string boneName)
    {
        if (GameState == null || GameState.Completed)
            return;

        var result = await GameService.MakeGuessAsync(GameState, boneName);

        if (result.Distance == -1)
        {
            // Invalid bone name
            return;
        }

        if (result.Distance == -2)
        {
            // Already guessed
            return;
        }

        BoneColors[result.BoneId] = result.HeatColor;
        GuessResults.Add(result);
        GuessedBoneNames.Add(result.BoneName);

        if (GameState.Completed)
        {
            Stats = await GameService.GetStatsAsync(GameMode.Location, Difficulty);

            // If won Level 1, show level up prompt
            if (GameState.Won && !IsLevelTwo)
            {
                ShowLevelUp = true;
            }
            else
            {
                ShowResult = true;
            }
        }

        StateHasChanged();
    }

    private void StartLevelTwo()
    {
        ShowLevelUp = false;
        var dateParam = DateOverride != null ? $"&date={DateOverride}" : "";
        Navigation.NavigateTo($"/location?level=2{dateParam}", forceLoad: true);
    }
}
